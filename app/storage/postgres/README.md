# PostgreSQL Storage Layer

Этот модуль содержит реализацию репозиториев для работы с PostgreSQL базой данных.

## Структура

- `db.py` - Менеджер подключения к базе данных
- `models.py` - SQLAlchemy модели для таблиц
- `user.py` - Репозиторий для пользователей
- `post.py` - Репозиторий для постов
- `post_tag.py` - Репозиторий для тегов постов

## Переменные окружения

Для работы с PostgreSQL необходимо установить следующие переменные окружения:

- `DB_HOST` - хост базы данных (по умолчанию: postgres)
- `DB_PORT` - порт базы данных (по умолчанию: 5432)
- `DB_NAME` - имя базы данных
- `DB_USER` - пользователь базы данных
- `DB_PASSWORD` - пароль базы данных

## Использование

Репозитории автоматически инициализируются в `app/cmd/public_api.py`. Параметры подключения к БД передаются в `db_manager.initialize()`.

## Особенности реализации

- Использование SQLAlchemy ORM для работы с базой данных
- Контекстные менеджеры для управления сессиями
- Автоматическое создание таблиц при инициализации
- Поддержка транзакций и отката изменений
- Связь many-to-many между постами и тегами через промежуточную таблицу
- Чистая архитектура: чтение переменных окружения происходит в `public_api.py`, а не внутри библиотеки
- Инъекция зависимостей: `DatabaseManager` передается в репозитории через конструктор
- Отсутствие глобальных переменных: каждый экземпляр `DatabaseManager` создается явно
- **Поддержка транзакций на уровне бизнес-логики**: возможность создавать транзакции, охватывающие несколько операций
- **Уровни изоляции транзакций**: поддержка различных уровней изоляции (READ_COMMITTED, REPEATABLE_READ, SERIALIZABLE)
- **Опциональные параметры сессий**: все методы репозиториев принимают опциональный параметр `session` для работы в рамках внешних транзакций

## Транзакции

### Базовое использование
```python
with db_manager.transaction() as session:
    # Все операции в рамках одной транзакции
    user_repo.create_user(user, session)
    post_repo.create_post(post, session)
    # Автоматический commit при успешном завершении
```

### Уровни изоляции
```python
from sqlalchemy.engine import IsolationLevel

# READ_COMMITTED (по умолчанию)
with db_manager.transaction(IsolationLevel.READ_COMMITTED) as session:
    # операции

# REPEATABLE_READ
with db_manager.transaction(IsolationLevel.REPEATABLE_READ) as session:
    # операции

# SERIALIZABLE
with db_manager.transaction(IsolationLevel.SERIALIZABLE) as session:
    # операции
```

### Примеры использования
Смотрите файл `transaction_example.py` для подробных примеров использования транзакций в бизнес-логике.
