#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ SimpleBlog

echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ SimpleBlog"
echo "=" * 50

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Python —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python3 –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ pip —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v pip3 &> /dev/null; then
    echo "‚ùå pip3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pip3 –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
pip3 install -r requirements-dev.txt

# –ó–∞–ø—É—Å–∫–∞–µ–º unit —Ç–µ—Å—Ç—ã
echo ""
echo "üî¨ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤..."
python3 -m pytest tests/unit/ -v --tb=short

if [ $? -eq 0 ]; then
    echo "‚úÖ Unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå Unit —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º acceptance —Ç–µ—Å—Ç—ã (—Ç—Ä–µ–±—É—é—Ç –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ API)
echo ""
echo "üåê –ó–∞–ø—É—Å–∫ acceptance —Ç–µ—Å—Ç–æ–≤..."
echo "‚ö†Ô∏è  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –∑–∞–ø—É—â–µ–Ω–æ (./run_dev.sh)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –¥–æ—Å—Ç—É–ø–Ω–æ
if curl -s http://localhost:8000/health > /dev/null; then
    echo "‚úÖ API –¥–æ—Å—Ç—É–ø–Ω–æ, –∑–∞–ø—É—Å–∫–∞–µ–º acceptance —Ç–µ—Å—Ç—ã..."
    python3 -m pytest tests/acceptance/ -v --tb=short

    if [ $? -eq 0 ]; then
        echo "‚úÖ Acceptance —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
    else
        echo "‚ùå Acceptance —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—à–ª–∏"
        exit 1
    fi
else
    echo "‚ö†Ô∏è  API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ./run_dev.sh —Å–Ω–∞—á–∞–ª–∞"
    echo "‚è≠Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º acceptance —Ç–µ—Å—Ç—ã"
fi

echo ""
echo "üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
echo "üìä –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: python3 -m pytest tests/ -v"
